"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0,require("./src/auto-filler.scss");function _instanceof(a,b){return null!=b&&"undefined"!=typeof Symbol&&b[Symbol.hasInstance]?b[Symbol.hasInstance](a):a instanceof b}function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _objectSpread(a){for(var b=1;b<arguments.length;b++){var c=null==arguments[b]?{}:arguments[b],d=Object.keys(c);"function"==typeof Object.getOwnPropertySymbols&&(d=d.concat(Object.getOwnPropertySymbols(c).filter(function(a){return Object.getOwnPropertyDescriptor(c,a).enumerable}))),d.forEach(function(b){_defineProperty(a,b,c[b])})}return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck(a,b){if(!_instanceof(a,b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _possibleConstructorReturn(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:_assertThisInitialized(a)}function _getPrototypeOf(a){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},_getPrototypeOf(a)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf(a,b)}function _setPrototypeOf(a,b){return _setPrototypeOf=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},_setPrototypeOf(a,b)}var _wp=wp,apiFetch=_wp.apiFetch,addQueryArgs=wp.url.addQueryArgs,_wp$element=wp.element,Component=_wp$element.Component,Fragment=_wp$element.Fragment,withInstanceId=wp.compose.withInstanceId,__=wp.i18n.__,_wp$components=wp.components,Spinner=_wp$components.Spinner,Popover=_wp$components.Popover,IconButton=_wp$components.IconButton,decodeEntities=wp.htmlEntities.decodeEntities;function debounce(a){var b,c=1<arguments.length&&arguments[1]!==void 0?arguments[1]:100;return function(){for(var d=this,e=arguments.length,f=Array(e),g=0;g<e;g++)f[g]=arguments[g];clearTimeout(b),b=setTimeout(function(){a.apply(d,f)},c)}}var _wp$components2=wp.components,PanelBody=_wp$components2.PanelBody,RangeControl=_wp$components2.RangeControl,ToggleControl=_wp$components2.ToggleControl,AutoFiller=function(a){function b(){var a;return _classCallCheck(this,b),a=_possibleConstructorReturn(this,_getPrototypeOf(b).apply(this,arguments)),a.state={autofill:!1,amount:1,taxonomy:!1,taxonomies:[],terms:[],loading:!1,selectedTerms:[],openPopover:!1,input:""},a.enableAutofill=a.enableAutofill.bind(_assertThisInitialized(a)),a.enableTaxonomies=a.enableTaxonomies.bind(_assertThisInitialized(a)),a.searchTaxonomy=a.searchTaxonomy.bind(_assertThisInitialized(a)),a.updateSearchResults=debounce(a.updateSearchResults.bind(_assertThisInitialized(a)),500),a.getSelectedTerms=a.getSelectedTerms.bind(_assertThisInitialized(a)),a}return _inherits(b,a),_createClass(b,[{key:"componentDidMount",value:function(){this.props.taxonomy&&this.getSelectedTerms()}},{key:"enableAutofill",value:function(){var a=this;this.props.autofill?this.setState({autofill:!1,taxonomy:!1},function(){a.props.autofillState({autofill:!1,taxonomy:!1})}):this.setState({autofill:!0},function(){a.props.autofillState({autofill:!0})})}},{key:"setAmount",value:function(a){var b=this;this.setState({amount:a},function(){b.props.setAmount(a)})}},{key:"enableTaxonomies",value:function(){var a=this;this.props.taxonomy?this.setState({taxonomies:[],terms:[]},function(){a.props.setTaxonomyState(!1)}):this.setState({taxonomy:!0},function(){a.props.setTaxonomyState(!0),a.getSelectedTerms()})}},{key:"getTaxonomies",value:function(){return apiFetch({path:addQueryArgs("/wp/v2/taxonomies",{per_page:-1})})}},{key:"searchTaxonomy",value:function(a){var b=this,c=a.target.value;this.setState({input:c},function(){b.updateSearchResults(c)})}},{key:"updateSearchResults",value:function(a){var b=this;1<a.length&&this.setState({loading:!0},function(){var c=[];b.getTaxonomies().then(function(d){delete d.yst_prominent_words;var e=_.values(d);b.setState({taxonomies:e},function(){b.state.taxonomies.map(function(d){return apiFetch({path:addQueryArgs("/wp/v2/".concat(d.rest_base,"?search=").concat(a),{per_page:-1})}).then(function(a){a.map(function(a){a.rest_base=d.rest_base}),c.push(a),b.setState({terms:_.flatten(c),openPopover:!0},function(){b.setState({loading:!1})})})})})})})}},{key:"selectTerm",value:function(a){var b={taxonomy:a.taxonomy,rest_base:a.rest_base,id:a.id},c=this.props.terms,d=c.find(function(a){return b.taxonomy===a.taxonomy}),e=c.find(function(a){var c=a.taxonomy,d=a.id;return b.taxonomy===c&&d.includes(b.id)});d?e?d.id.splice(d.id.indexOf(b.id),1):d.id.push(b.id):c.push(_objectSpread({},b,{id:[b.id]})),this.props.setTerms(_toConsumableArray(c)),this.getSelectedTerms(),this.setState({openPopover:!1,input:""})}},{key:"getSelectedTerms",value:function(){var a=this;this.getTaxonomies().then(function(b){delete b.yst_prominent_words;var c=_.values(b);a.setState({taxonomies:c})});var b=[];this.setState({selectedTerms:[]},function(){a.setState({loading:!1})}),this.props.terms.flatMap(function(c){var d=c.rest_base,e=c.id;return e.map(function(c){a.setState({loading:!0}),apiFetch({path:addQueryArgs("/wp/v2/".concat(d,"/").concat(c))}).then(function(c){b.push(c),a.setState({selectedTerms:b},function(){a.setState({loading:!1})})})})})}},{key:"render",value:function(){var a=this;return React.createElement(Fragment,null,React.createElement("div",{className:"auto-filler"},React.createElement(PanelBody,{title:__("Autofiller","autofiller")},React.createElement(ToggleControl,{label:__("Enable automatic filling","autofiller"),checked:this.props.autofill,onChange:function(){return a.enableAutofill()}})),this.props.autofill?React.createElement(PanelBody,{title:1==this.props.amount?__("Fill with ".concat(this.props.amount," item"),"autofiller"):__("Fill till ".concat(this.props.amount," items"),"autofiller")},React.createElement(RangeControl,{value:this.props.amount,onChange:function(b){return a.setAmount(b)},min:1,max:this.props.limit,step:1}),React.createElement(ToggleControl,{label:__("Fill with items from Taxonomies","autofiller"),checked:this.props.taxonomy,onChange:function(){return a.enableTaxonomies()}})):null,this.props.taxonomy&&this.props.autofill?React.createElement(PanelBody,{title:__("Taxonomies","autofiller")},React.createElement("div",{className:"auto-filler__group"},React.createElement("div",{className:"auto-fill-loader"+" ".concat(this.state.loading?"":"auto-fill-loader--hide"," ")},React.createElement(Spinner,null)),React.createElement("input",{type:"search",placeholder:__("Search in Taxonomies","autofiller"),value:this.state.input,onChange:this.searchTaxonomy,"aria-expanded":this.state.openPopover,required:!0,className:"auto-filler__input"}),this.state.openPopover&&!!this.state.terms.length&&React.createElement(Popover,{position:"top",noArrow:!0,focusOnMount:!1},React.createElement("div",{className:"autofill-suggestions"},React.createElement("div",{className:"editor-url-input__suggestions",role:"listbox"},this.state.terms.map(function(b){return React.createElement("button",{key:b.id,role:"option",onClick:function(){return a.selectTerm(b)},className:"editor-url-input__suggestion"},React.createElement("div",{className:"suggested-item"},React.createElement("span",{className:"suggested-item__title"},decodeEntities(b.name)||__("No title","autofiller"))))})))),this.state.selectedTerms.length?React.createElement("div",null,this.state.taxonomies.map(function(b){return React.createElement("div",{key:b.id},React.createElement("div",{className:"autofiller-title"},b.name),React.createElement("ul",{className:"autofiller-tags"},a.state.selectedTerms.map(function(c){if(c.taxonomy==b.slug)return React.createElement("li",{className:"autofiller-tags__item",key:c.id},React.createElement("div",{className:"autofiller-tag"},React.createElement("div",{className:"autofiller-tag__name"},c.name),React.createElement(IconButton,{onClick:function(){return a.selectTerm(c)},icon:"dismiss",className:"autofiller-tag__icon"})))})))})):null)):null))}}]),b}(Component),_default=withInstanceId(AutoFiller);exports["default"]=_default;